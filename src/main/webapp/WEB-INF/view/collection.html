<!DOCTYPE html>
<html>

<head>
	<meta charset="utf-8">
	<title>客户收款管理</title>
	<meta name="renderer" content="webkit">
	<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
	<meta name="apple-mobile-web-app-status-bar-style" content="black">
	<meta name="apple-mobile-web-app-capable" content="yes">
	<meta name="format-detection" content="telephone=no">

	<link rel="stylesheet" href="plugins/layui/css/layui.css" media="all" />
	<link rel="stylesheet" href="plugins/font-awesome/css/font-awesome.min.css">
	<script src="http://code.jquery.com/jquery-latest.js"></script>
</head>

<body onload="init();">
<div style="margin: 15px;">
	<fieldset class="layui-elem-field layui-field-title" style="margin-top: 20px;">
		<legend>客户收款管理</legend>
	</fieldset>

	<form class="layui-form" action="">
		<div class="layui-form-item">
			<label class="layui-form-label">收款方式</label>
			<div class="layui-input-block">
				<input type="text" name="收款方式"id="collectionWay" lay-verify="收款方式" autocomplete="off" placeholder="请输入" class="layui-input">
			</div>
		</div>
		<div class="layui-form-item">
			<label class="layui-form-label">收款类别</label>
			<div class="layui-input-block">
				<select name="收款类别" id="collectionItem" lay-filter="收款类别">
					<option value=""></option>
					<option value="0" selected="">普通</option>
					<option value="1">量房定金</option>
				</select>
			</div>
		</div>
		<div class="layui-form-item">
			<label class="layui-form-label">收款日期</label>
			<div class="layui-input-block">
				<input type="text" name="收款日期" id="collectionDate" lay-verify="收款日期" placeholder="yyyy-mm-dd" autocomplete="off" class="layui-input" onclick="layui.laydate({elem: this})">
			</div>
		</div>
		<div class="layui-form-item">
			<label class="layui-form-label">收款项目</label>
			<div class="layui-input-block">
				<input type="text" name="收款项目"id="projectName" onmouseout="" autocomplete="off" placeholder="请输入" class="layui-input">
				<input type="hidden" id="projectId">
				<input type="hidden" id="price">
				<input type="hidden" id="projectCollectionValueRemain">
			</div>
		</div>
		<div class="layui-form-item">
			<label class="layui-form-label">收款金额</label>
			<div class="layui-input-block">
				<input type="text" id="collectionValue"  name="收款金额" lay-verify="number" autocomplete="off" class="layui-input">
			</div>
		</div>
		<div class="layui-form-item">
			<label class="layui-form-label">收款占比</label>
			<div class="layui-input-block">
				<input type="text" id="collectionRate" name="收款占比" autocomplete="off" class="layui-input">
			</div>
		</div>
		<div class="layui-form-item">
			<div class="layui-input-block">
				<button onclick="createCollection();" class="layui-btn" lay-submit="" lay-filter="demo1">立即提交</button>
				<button id="refresh" type="reset" class="layui-btn layui-btn-primary">重置</button>
			</div>
		</div>
	</form>
</div>
<script type="text/javascript" src="plugins/layui/layui.js"></script>
<script>
    var project;

    function init() {
        $('#projectName').on("blur", function () {
            var name = $("#projectName").val();
            $.ajax({
                type: "GET",
                dataType: "json",
                contentType: "application/x-www-form-urlencoded; charset=utf-8",
                url: "/project?projectName=" + name,
                success: function (result) {
                    if (result.status == 1) {
                        alert("获取失败，请重新输入");
                        $("#projectName").text("");
                    } else {
                        project = result.data;
                        console.log(project);
                        $("#projectId").val(project.projectId);
                        console.log(project.projectPrice);
                        $("#price").val(project.projectPrice);
                        $("#projectCollectionValueRemain").val(project.projectCollectionValueRemain);
                    }
                }
            });
        });

        $('#collectionValue').on("blur", function () {
            if ($("#collectionItem").val() == 0) {
                if ($("#projectCollectionValueRemain").val() < $("#collectionValue").val()) {
                    alert("收款金额大于该项目未收金额，请重新输入");
                    $("#collectionValue").val("");
                } else {
                    $("#collectionRate").val($("#collectionValue").val() / $("#price").val() * 100 + "%");
				}
            } else {
                $("#collectionRate").val("100%");
            }
        });
    }

    function createCollection(){
        var collection={};
        collection.collectionDate = $("#collectionDate").val();
        collection.collectionWay = $("#collectionWay").val();
        collection.collectionItem = $("#collectionItem").val();
        collection.collectionValue = $("#collectionValue").val();
        collection.projectId = $("#projectId").val();
        collection.collectionRate = $("#collectionRate").val();


        $.ajax({
            type: "POST",
            contentType: "application/json",
            url: "/finance/collection",
            data: collection,
            success: function (result) {
                if (result.status == 1) {
                    alert("创建失败，请重新输入");
                } else {
                    alert("创建成功");
                }
                $("#refresh").click();
            }
        });
    }
    layui.use(['form', 'layedit', 'laydate'], function() {
        var form = layui.form(),
            layer = layui.layer,
            layedit = layui.layedit,
            laydate = layui.laydate;
    });
</script>
</body>

</html>